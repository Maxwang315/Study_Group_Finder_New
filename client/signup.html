<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign Up - Study Group Finder</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container" style="max-width: 400px; text-align: center;">
    <h1>Create Account</h1>
    <form class="card form" id="signupForm" novalidate>
      <div id="signupMessage" class="alert hidden" role="alert" aria-live="polite"></div>

      <!-- Name -->
      <div class="field">
        <label for="name">Full Name</label>
        <input id="name" name="name" type="text" autocomplete="name" required />
      </div>

      <!-- Email -->
      <div class="field">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" autocomplete="email" required />
      </div>

      <!-- Password -->
      <div class="field">
        <label for="password">Password</label>
        <input id="password" name="password" type="password" required />
      </div>

      <!-- Confirm Password -->
      <div class="field">
        <label for="confirm">Confirm Password</label>
        <input id="confirm" name="confirm" type="password" required />
        <small id="pwError" style="color: red; display: none;">❌ Passwords do not match</small>
      </div>

      <!-- University selection -->
      <div class="field">
        <label for="universitySearch">University</label>
        <input type="text" id="universitySearch" placeholder="Type to filter universities..." />
        <select id="university" name="university" required>
          <option value="">-- Select your university --</option>
        </select>
      </div>

      <!-- Submit -->
      <button class="btn btn-primary" type="submit" id="signupSubmit">Sign Up</button>
    </form>

    <p style="margin-top: 1rem;">
      Already have an account? <a href="login.html">Login</a>
    </p>
  </main>

  <script>
  const STORAGE_USER_KEY = "sgfUser";
  const UNIVERSITY_KEY = "sgfUniversity";
  const UNIVERSITY_LABEL_KEY = "sgfUniversityLabel";
  const USERNAME_KEY = "sgfUsername";

  // ========== Load universities ==========
  fetch("universities.json")
    .then(response => response.json())
    .then(data => {
      const select = document.getElementById("university");
      select.innerHTML = "<option value=''>-- Select your university --</option>";

      // Filter only Canada + US
      const filtered = data.filter(u => u.alpha_two_code === "CA" || u.alpha_two_code === "US");

      // Sort alphabetically
      filtered.sort((a, b) => a.name.localeCompare(b.name));

      // Add options
      filtered.forEach(u => {
        const option = document.createElement("option");
        option.value = u.name;
        option.textContent = `${u.name} (${u.country})`;
        select.appendChild(option);
      });

      // Pre-select previously chosen university if available
      const savedUniversity = localStorage.getItem(UNIVERSITY_KEY);
      if (savedUniversity) {
        select.value = savedUniversity;
      }
    })
    .catch(err => {
      console.error("Error loading universities:", err);
      document.getElementById("university").innerHTML =
        "<option value=''>Could not load universities</option>";
    });

  // ========== Password confirmation ==========
  const signupForm = document.getElementById("signupForm");
  const signupMessage = document.getElementById("signupMessage");
  const submitButton = document.getElementById("signupSubmit");

  const showMessage = (type, message) => {
    signupMessage.textContent = message;
    signupMessage.classList.remove("hidden", "alert-success", "alert-error");
    signupMessage.classList.add(type === "success" ? "alert-success" : "alert-error");
  };

  const clearMessage = () => {
    signupMessage.textContent = "";
    signupMessage.classList.add("hidden");
    signupMessage.classList.remove("alert-success", "alert-error");
  };

  const setLoading = (loading) => {
    submitButton.disabled = loading;
    submitButton.textContent = loading ? "Signing up…" : "Sign Up";
  };

  signupForm.addEventListener("submit", async (event) => {
    event.preventDefault();
    clearMessage();

    const pw = document.getElementById("password").value;
    const confirmPw = document.getElementById("confirm").value;
    const error = document.getElementById("pwError");
    const select = document.getElementById("university");
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();

    if (pw !== confirmPw) {
      error.style.display = "block";
      showMessage("error", "Passwords do not match");
      return;
    }

    error.style.display = "none";

    const university = select.value;
    const universityLabel = select.options[select.selectedIndex]?.textContent ?? university;

    if (!university) {
      showMessage("error", "Please choose your university.");
      return;
    }

    setLoading(true);

    try {
      const response = await fetch("/api/auth/signup", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify({
          name,
          email,
          password: pw,
          university,
        }),
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        const message = data?.message || "Could not create your account. Please try again.";
        showMessage("error", message);
        return;
      }

      const user = data?.user;

      if (user?.name) {
        localStorage.setItem(USERNAME_KEY, user.name);
      } else if (name) {
        localStorage.setItem(USERNAME_KEY, name);
      }

      if (user?.university || university) {
        const universityValue = user?.university ?? university;
        localStorage.setItem(UNIVERSITY_KEY, universityValue);
        localStorage.setItem(UNIVERSITY_LABEL_KEY, universityLabel);
      }

      if (user) {
        localStorage.setItem(STORAGE_USER_KEY, JSON.stringify(user));
      }

      showMessage("success", "Account created! Redirecting…");

      setTimeout(() => {
        window.location.href = "studyGroupFinderMain.html";
      }, 800);
    } catch (fetchError) {
      console.error(fetchError);
      showMessage("error", "Network error creating account. Please check your connection and try again.");
    } finally {
      setLoading(false);
    }
  });

  // ========== University filter ==========
  const searchBox = document.getElementById("universitySearch");
  const select = document.getElementById("university");

  searchBox.addEventListener("input", function() {
    const filter = this.value.toLowerCase();
    const options = select.querySelectorAll("option");

    let firstMatch = null;

    options.forEach(opt => {
      if (opt.value === "") return; // skip placeholder
      if (opt.textContent.toLowerCase().includes(filter)) {
        opt.style.display = "";
        if (!firstMatch) firstMatch = opt; // remember the first visible match
      } else {
        opt.style.display = "none";
      }
    });

    // Auto-select the first match
    if (firstMatch) {
      select.value = firstMatch.value;
    } else {
      select.value = ""; // reset if nothing matches
    }
  });

  // ========== Autofill search bar when dropdown changes ==========
  select.addEventListener("change", function() {
    const chosen = select.options[select.selectedIndex]?.textContent ?? "";
    if (chosen && select.value !== "") {
      searchBox.value = chosen; // copy dropdown choice into search bar
    }
  });
  </script>

</body>
</html>
